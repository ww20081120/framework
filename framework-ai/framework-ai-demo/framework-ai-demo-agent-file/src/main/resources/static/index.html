<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Agent æµå¼è¾“å‡ºæ¼”ç¤º</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .input-section {
            margin-bottom: 30px;
        }
        
        textarea {
            width: 100%;
            height: 100px;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            resize: vertical;
            box-sizing: border-box;
        }
        
        textarea:focus {
            outline: none;
            border-color: #4CAF50;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        button {
            flex: 1;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .btn-primary {
            background-color: #4CAF50;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #45a049;
        }
        
        .btn-secondary {
            background-color: #2196F3;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #1976D2;
        }
        
        .btn-danger {
            background-color: #f44336;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #d32f2f;
        }
        
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        .output-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 30px;
        }
        
        .output-box {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            background-color: #fafafa;
            min-height: 300px;
        }
        
        .output-box h3 {
            margin-top: 0;
            color: #555;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        
        .output-content {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 400px;
            overflow-y: auto;
            min-height: 300px;
        }
        
        .thinking {
            color: #666;
            font-style: italic;
            white-space: pre-wrap; /* ç¡®ä¿æ€è€ƒè¿‡ç¨‹å†…å®¹æ­£ç¡®æ¢è¡Œ */
            word-wrap: break-word;
        }
        
        .answer {
            color: #333;
            font-weight: normal;
            white-space: pre-wrap; /* ç¡®ä¿ç­”æ¡ˆå†…å®¹æ­£ç¡®æ¢è¡Œ */
            word-wrap: break-word;
        }
        
        .error {
            color: #d32f2f;
            font-weight: bold;
            white-space: pre-wrap; /* ç¡®ä¿é”™è¯¯ä¿¡æ¯æ­£ç¡®æ¢è¡Œ */
            word-wrap: break-word;
        }
        
        .status {
            background-color: #e3f2fd;
            border: 1px solid #2196F3;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .clear-btn {
            background-color: #FF9800;
            color: white;
            margin-top: 20px;
        }
        
        .clear-btn:hover {
            background-color: #F57C00;
        }
        
        @media (max-width: 768px) {
            .output-section {
                grid-template-columns: 1fr;
            }
            
            .button-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¤– AI Agent æµå¼è¾“å‡ºæ¼”ç¤º</h1>
        
        <div class="status" id="status">
            å‡†å¤‡å°±ç»ªï¼Œè¯·è¾“å…¥ä»»åŠ¡æè¿°
        </div>
        
        <div class="input-section">
            <textarea id="taskInput" placeholder="è¯·è¾“å…¥æ‚¨å¸Œæœ›AIæ‰§è¡Œçš„ä»»åŠ¡ï¼Œä¾‹å¦‚ï¼š&#10;&#10;1. åˆ†æä¸€ä¸ªJavaæ–‡ä»¶çš„ä»£ç è´¨é‡&#10;2. ç”Ÿæˆä¸€ä¸ªPythonè„šæœ¬æ¥å¤„ç†æ•°æ®&#10;3. åˆ›å»ºä¸€ä¸ªç®€å•çš„Webåº”ç”¨"></textarea>
            
            <div class="button-group">
                <button class="btn-primary" onclick="executeStream()" id="streamBtn">
                    ğŸš€ æµå¼è¾“å‡º (SSE)
                </button>
                <button class="btn-secondary" onclick="executeFlux()" id="fluxBtn">
                    âš¡ ç®€åŒ–æµå¼ (Flux)
                </button>
                <button class="btn-danger" onclick="executeNormal()" id="normalBtn">
                    ğŸ“‹ ä¼ ç»Ÿæ–¹å¼
                </button>
            </div>
        </div>
        
        <div class="output-section">
            <div class="output-box">
                <h3>ğŸ§  æ€è€ƒè¿‡ç¨‹</h3>
                <div id="thinkingOutput" class="output-content"></div>
            </div>
            
            <div class="output-box">
                <h3>ğŸ’¬ æœ€ç»ˆç­”æ¡ˆ</h3>
                <div id="answerOutput" class="output-content"></div>
            </div>
        </div>
        
        <button class="clear-btn" onclick="clearOutputs()">ğŸ—‘ï¸ æ¸…ç©ºè¾“å‡º</button>
    </div>

    <script>
        let currentEventSource = null;
        let isThinking = true;

        function updateStatus(message, isLoading = false) {
            const statusEl = document.getElementById('status');
            statusEl.innerHTML = isLoading ? 
                '<span class="loading"></span>' + message : message;
        }

        function clearOutputs() {
            document.getElementById('thinkingOutput').innerHTML = '';
            document.getElementById('answerOutput').innerHTML = '';
            updateStatus('è¾“å‡ºå·²æ¸…ç©º');
            
            if (currentEventSource) {
                currentEventSource.close();
                currentEventSource = null;
            }
        }

        function appendToOutput(elementId, text, className = '') {
            const output = document.getElementById(elementId);
            const span = document.createElement('span');
            span.className = className;
            span.textContent = text;
            output.appendChild(span);
            output.scrollTop = output.scrollHeight;
        }

        function getTask() {
            const task = document.getElementById('taskInput').value.trim();
            if (!task) {
                alert('è¯·è¾“å…¥ä»»åŠ¡æè¿°');
                return null;
            }
            return task;
        }

        function disableButtons(disabled) {
            document.getElementById('streamBtn').disabled = disabled;
            document.getElementById('fluxBtn').disabled = disabled;
            document.getElementById('normalBtn').disabled = disabled;
        }

        // SSE æµå¼è¾“å‡º
        function executeStream() {
            const task = getTask();
            if (!task) return;

            clearOutputs();
            disableButtons(true);
            updateStatus('æ­£åœ¨æ‰§è¡Œæµå¼è¾“å‡º...', true);
            isThinking = true;

            // å…³é—­ä¹‹å‰çš„è¿æ¥
            if (currentEventSource) {
                currentEventSource.close();
            }

            currentEventSource = new EventSource(`/api/agent/solve-stream?task=${encodeURIComponent(task)}`);

            // å¤„ç†ä¸åŒç±»å‹çš„SSEäº‹ä»¶
            currentEventSource.addEventListener('start', function(event) {
                updateStatus('å¼€å§‹å¤„ç†ä»»åŠ¡...', true);
                appendToOutput('thinkingOutput', event.data + '\n', 'thinking');
            });

            currentEventSource.addEventListener('thinking', function(event) {
                appendToOutput('thinkingOutput', event.data, 'thinking');
            });

            currentEventSource.addEventListener('thinking_complete', function(event) {
                isThinking = false;
                updateStatus('æ€è€ƒå®Œæˆï¼Œç”Ÿæˆæœ€ç»ˆç­”æ¡ˆ...', true);
                appendToOutput('thinkingOutput', event.data + '\n', 'thinking');
            });

            currentEventSource.addEventListener('answer', function(event) {
                appendToOutput('answerOutput', event.data, 'answer');
            });

            currentEventSource.addEventListener('complete', function(event) {
                updateStatus('âœ… ä»»åŠ¡å®Œæˆ');
                disableButtons(false);
                currentEventSource.close();
                currentEventSource = null;
            });

            currentEventSource.addEventListener('error', function(event) {
                appendToOutput('thinkingOutput', event.data + '\n', 'error');
                updateStatus('âŒ æ‰§è¡Œå‡ºé”™');
                disableButtons(false);
                currentEventSource.close();
                currentEventSource = null;
            });

            // é€šç”¨æ¶ˆæ¯å¤„ç†å™¨ï¼ˆå¤„ç†æœªåˆ†ç±»çš„äº‹ä»¶ï¼‰
            currentEventSource.onmessage = function(event) {
                console.log('æ”¶åˆ°æœªåˆ†ç±»çš„SSEæ¶ˆæ¯:', event);
                // å¦‚æœæ²¡æœ‰ç‰¹å®šçš„äº‹ä»¶ç±»å‹ï¼Œé»˜è®¤æ·»åŠ åˆ°æ€è€ƒè¿‡ç¨‹
                if (event.data && event.data.trim()) {
                    appendToOutput('thinkingOutput', event.data + '\n', 'thinking');
                }
            };

            currentEventSource.onerror = function(event) {
                console.error('SSEé”™è¯¯:', event);
                appendToOutput('thinkingOutput', 'è¿æ¥é”™è¯¯æˆ–ä¸­æ–­\n', 'error');
                updateStatus('âŒ è¿æ¥é”™è¯¯');
                disableButtons(false);
                currentEventSource.close();
                currentEventSource = null;
            };
        }

        // Flux æµå¼è¾“å‡º
        async function executeFlux() {
            const task = getTask();
            if (!task) return;

            clearOutputs();
            disableButtons(true);
            updateStatus('æ­£åœ¨æ‰§è¡Œç®€åŒ–æµå¼è¾“å‡º...', true);

            try {
                const response = await fetch(`/api/agent/solve-flux?task=${encodeURIComponent(task)}`, {
                    headers: {
                        'Accept': 'text/event-stream'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.trim()) {
                            if (line.startsWith('ğŸ¤–') || line.includes('å¼€å§‹å¤„ç†ä»»åŠ¡')) {
                                appendToOutput('thinkingOutput', line + '\n', 'thinking');
                            } else if (line.includes('âœ…') && line.includes('ä»»åŠ¡å®Œæˆ')) {
                                updateStatus('âœ… ä»»åŠ¡å®Œæˆ');
                                appendToOutput('answerOutput', line + '\n', 'answer');
                            } else if (line.startsWith('âŒ')) {
                                appendToOutput('thinkingOutput', line + '\n', 'error');
                                updateStatus('âŒ æ‰§è¡Œå‡ºé”™');
                            } else {
                                appendToOutput('answerOutput', line, 'answer');
                            }
                        }
                    }
                }

                updateStatus('âœ… ä»»åŠ¡å®Œæˆ');
            } catch (error) {
                console.error('Fluxé”™è¯¯:', error);
                appendToOutput('thinkingOutput', `é”™è¯¯: ${error.message}\n`, 'error');
                updateStatus('âŒ æ‰§è¡Œå‡ºé”™');
            } finally {
                disableButtons(false);
            }
        }

        // ä¼ ç»Ÿæ–¹å¼
        async function executeNormal() {
            const task = getTask();
            if (!task) return;

            clearOutputs();
            disableButtons(true);
            updateStatus('æ­£åœ¨æ‰§è¡Œä¼ ç»Ÿæ–¹å¼...', true);

            try {
                const response = await fetch(`/api/agent/solve?task=${encodeURIComponent(task)}`);
                const result = await response.text();

                appendToOutput('thinkingOutput', 'ä½¿ç”¨ä¼ ç»ŸåŒæ­¥æ–¹å¼æ‰§è¡Œä»»åŠ¡...\n', 'thinking');
                appendToOutput('answerOutput', result, 'answer');

                updateStatus('âœ… ä»»åŠ¡å®Œæˆ');
            } catch (error) {
                console.error('ä¼ ç»Ÿæ–¹å¼é”™è¯¯:', error);
                appendToOutput('thinkingOutput', `é”™è¯¯: ${error.message}\n`, 'error');
                updateStatus('âŒ æ‰§è¡Œå‡ºé”™');
            } finally {
                disableButtons(false);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // æ·»åŠ ç¤ºä¾‹ä»»åŠ¡
            const examples = [
                "åˆ†æä¸€ä¸ªJavaç±»çš„ä»£ç è´¨é‡ï¼Œç»™å‡ºæ”¹è¿›å»ºè®®",
                "ç”Ÿæˆä¸€ä¸ªPythonè„šæœ¬æ¥è¯»å–CSVæ–‡ä»¶å¹¶è¿›è¡Œæ•°æ®åˆ†æ",
                "åˆ›å»ºä¸€ä¸ªç®€å•çš„Spring Boot REST APIç¤ºä¾‹",
                "å†™ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼æ¥éªŒè¯é‚®ç®±åœ°å€"
            ];
            
            const randomExample = examples[Math.floor(Math.random() * examples.length)];
            document.getElementById('taskInput').placeholder = `ä¾‹å¦‚ï¼š${randomExample}`;
        });

        // é¡µé¢å¸è½½æ—¶å…³é—­è¿æ¥
        window.addEventListener('beforeunload', function() {
            if (currentEventSource) {
                currentEventSource.close();
            }
        });
    </script>
</body>
</html>
